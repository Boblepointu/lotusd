name: ⛏️ Lotus Miner Windows Build

on:
  workflow_call:
    inputs:
      version:
        description: "The version to build"
        required: true
        type: string
    outputs:
      build_status:
        description: "The status of the build"
        value: ${{ jobs.build-lotus-gpu-miner-windows.outputs.build_status }}

jobs:
  build-lotus-gpu-miner-windows:
    name: 🪟 Build Windows lotus-gpu-miner
    runs-on: windows-latest
    outputs:
      build_status: ${{ job.status }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.ref_name }}

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true
        components: rustfmt, clippy

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "gpuminer -> target"

    - name: Create artifacts directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path ./artifacts
        New-Item -ItemType Directory -Force -Path ./debug-info

    - name: Build Windows miner
      shell: pwsh
      run: |
        echo "Starting Windows GPU miner build..."
        
        # Debug information
        echo "Current directory: $(Get-Location)"
        echo "Branch name: $env:GITHUB_REF_NAME"
        
        # Check if gpuminer directory exists
        if (Test-Path -Path "gpuminer") {
            echo "gpuminer directory found"
        } else {
            echo "ERROR: gpuminer directory not found. Directory contents:"
            Get-ChildItem -Path .
            exit 1
        }
        
        # Navigate to the gpuminer directory
        cd gpuminer
        
        # Show Cargo.toml contents for debugging
        echo "Cargo.toml contents:"
        if (Test-Path -Path "Cargo.toml") {
            Get-Content -Path "Cargo.toml"
        } else {
            echo "ERROR: Cargo.toml not found!"
            exit 1
        }
        
        # Build the miner in release mode with verbose output
        echo "Running cargo build..."
        cargo build --release --package lotus-miner-cli -v
        
        if ($LASTEXITCODE -ne 0) {
          echo "ERROR: Cargo build failed!"
          exit 1
        }
        
        # Verify target directory exists
        if (Test-Path -Path "target/release") {
            echo "Release build directory exists"
        } else {
            echo "ERROR: Release build directory not found!"
            exit 1
        }
        
        # Copy the binary to artifacts directory
        cp -v target/release/lotus-miner-cli.exe ../artifacts/
        
        # Create a copy with alternative name
        cp -v ../artifacts/lotus-miner-cli.exe ../artifacts/lotus-gpu-miner.exe
        
        # Copy kernels directory (important for GPU operation)
        cp -r kernels ../artifacts/
        
        # Verify files exist
        echo "Contents of artifacts directory:"
        ls -la ../artifacts/
        
        # Save file metadata
        echo "Build completed. Writing debug information..."
        ls -la ../artifacts > ../debug-info/artifacts-list.txt
        Get-ChildItem -Recurse ../artifacts | Select-Object FullName, Length | Format-Table -AutoSize > ../debug-info/detailed-artifacts.txt
        
        # Capture Rust version info
        rustc --version > ../debug-info/rust-version-info.txt
        cargo --version >> ../debug-info/rust-version-info.txt
        
        echo "Windows build completed successfully."

    # Upload Windows GPU miner binary artifacts with kernels
    - name: Upload Windows GPU miner artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lotus-gpu-miner-windows-${{ inputs.version }}
        path: |
          ./artifacts/*.exe
          ./artifacts/kernels/
        retention-days: 14
    
    # Upload debug info
    - name: Upload debug info
      uses: actions/upload-artifact@v4
      with:
        name: lotus-gpu-miner-windows-debug-${{ inputs.version }}
        path: ./debug-info/
        retention-days: 3
        
